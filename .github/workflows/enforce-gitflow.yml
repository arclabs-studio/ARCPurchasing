name: Enforce Git Flow

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

jobs:
  validate-branch-rules:
    name: Validate Branch Rules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch targeting
        run: |
          TARGET="${{ github.base_ref }}"
          SOURCE="${{ github.head_ref }}"

          echo "üåø Validating branch rules..."
          echo "Source branch: $SOURCE"
          echo "Target branch: $TARGET"
          echo ""

          # Rule 1: feature/* branches must target develop
          if [[ $SOURCE == feature/* ]] && [[ $TARGET != "develop" ]]; then
            echo "‚ùå ERROR: Feature branches must target 'develop'"
            echo "   Branch: $SOURCE"
            echo "   Target: $TARGET"
            echo ""
            echo "‚ÑπÔ∏è  Change the base branch of this PR to 'develop'"
            exit 1
          fi

          # Rule 2: hotfix/* branches must target main
          if [[ $SOURCE == hotfix/* ]] && [[ $TARGET != "main" ]]; then
            echo "‚ùå ERROR: Hotfix branches must target 'main'"
            echo "   Branch: $SOURCE"
            echo "   Target: $TARGET"
            echo ""
            echo "‚ÑπÔ∏è  Change the base branch of this PR to 'main'"
            exit 1
          fi

          # Rule 3: Only develop or hotfix/* can target main
          if [[ $TARGET == "main" ]]; then
            if [[ $SOURCE != "develop" ]] && [[ $SOURCE != hotfix/* ]]; then
              echo "‚ùå ERROR: Only 'develop' or 'hotfix/*' branches can target 'main'"
              echo "   Branch: $SOURCE"
              echo ""
              echo "‚ÑπÔ∏è  Merge your changes to 'develop' first, then create a release PR"
              exit 1
            fi
          fi

          echo "‚úÖ Branch targeting is correct"

      - name: Validate branch naming
        run: |
          SOURCE="${{ github.head_ref }}"

          echo "üè∑Ô∏è Validating branch naming convention..."

          # Check if branch follows naming convention
          if [[ $SOURCE =~ ^(feature|hotfix|bugfix|release)/.+ ]]; then
            echo "‚úÖ Branch name follows convention: $SOURCE"
          elif [[ $SOURCE == "develop" ]] || [[ $SOURCE == "main" ]]; then
            echo "‚úÖ Main branch: $SOURCE"
          else
            echo "‚ö†Ô∏è  WARNING: Branch name doesn't follow convention"
            echo "   Branch: $SOURCE"
            echo "   Expected: feature/*, hotfix/*, bugfix/*, release/*"
            echo ""
            echo "‚ÑπÔ∏è  This is a warning only - PR can still be merged"
          fi

      - name: Check conventional commits
        continue-on-error: true
        run: |
          echo "üí¨ Checking commit messages..."

          # Get commits in this PR
          git log --format=%s ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} > /tmp/commits.txt

          NON_CONVENTIONAL=0

          while IFS= read -r commit; do
            # Check if commit follows conventional commits format
            if [[ ! $commit =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?!?:\ .+ ]]; then
              echo "‚ö†Ô∏è  Non-conventional commit: $commit"
              ((NON_CONVENTIONAL++))
            fi
          done < /tmp/commits.txt

          if [ $NON_CONVENTIONAL -gt 0 ]; then
            echo ""
            echo "‚ö†Ô∏è  Found $NON_CONVENTIONAL commit(s) not following Conventional Commits"
            echo ""
            echo "‚ÑπÔ∏è  Conventional Commits format:"
            echo "   <type>(<scope>): <subject>"
            echo ""
            echo "   Types: feat, fix, docs, style, refactor, perf, test, chore, ci, build, revert"
            echo ""
            echo "   Examples:"
            echo "   - feat: add new configuration option"
            echo "   - fix: resolve issue with setup script"
            echo "   - docs: update installation instructions"
            echo ""
            echo "‚ÑπÔ∏è  This is a warning only - PR can still be merged"
          else
            echo "‚úÖ All commits follow Conventional Commits format"
          fi

      - name: Generate validation summary
        if: always()
        run: |
          echo "## üåø Git Flow Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** \`${{ github.head_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** \`${{ github.base_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Branch targeting rules validated" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Branch naming convention checked" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ö†Ô∏è  Commit message format checked (warnings only)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Git Flow Rules" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. \`feature/*\` ‚Üí \`develop\` only" >> $GITHUB_STEP_SUMMARY
          echo "2. \`hotfix/*\` ‚Üí \`main\` only" >> $GITHUB_STEP_SUMMARY
          echo "3. \`develop\` or \`hotfix/*\` ‚Üí \`main\` only" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [CONTRIBUTING.md](../CONTRIBUTING.md) for complete guidelines." >> $GITHUB_STEP_SUMMARY
