name: Sync Develop

on:
  push:
    branches:
      - main
    tags-ignore:
      - '**'
  workflow_dispatch:

jobs:
  sync-branches:
    name: Sync main â†’ develop
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    # Don't run if triggered by bot to prevent loops
    if: "!contains(github.actor, '[bot]')"

    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch main
        run: git fetch origin main

      - name: Merge main into develop
        id: merge
        run: |
          echo "ðŸ”„ Attempting to merge main into develop..."

          if git merge origin/main --no-ff -m "ðŸ”„ chore: sync develop with main

          Automated sync after merge to main.

          Workflow: ${{ github.workflow }}
          Run: ${{ github.run_number }}
          Triggered by: ${{ github.event_name }}"; then
            echo "merge_status=success" >> $GITHUB_OUTPUT
            echo "âœ… Merge successful"
          else
            echo "merge_status=conflict" >> $GITHUB_OUTPUT
            echo "âŒ Merge conflict detected"
            git merge --abort
            exit 1
          fi

      - name: Push changes
        if: steps.merge.outputs.merge_status == 'success'
        run: |
          git push origin develop
          echo "âœ… Changes pushed to develop"

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ”„ Develop Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.merge.outputs.merge_status }}" == "success" ]; then
            echo "âœ… **Status:** Success" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The \`develop\` branch has been successfully synchronized with \`main\`." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Conflict" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action required:** Manual merge needed due to conflicts." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### To resolve:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "git checkout develop" >> $GITHUB_STEP_SUMMARY
            echo "git pull origin develop" >> $GITHUB_STEP_SUMMARY
            echo "git merge origin/main" >> $GITHUB_STEP_SUMMARY
            echo "# Resolve conflicts" >> $GITHUB_STEP_SUMMARY
            echo "git commit" >> $GITHUB_STEP_SUMMARY
            echo "git push origin develop" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create conflict issue
        if: failure() && steps.merge.outputs.merge_status == 'conflict'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”„ Manual merge required: main â†’ develop',
              body: `## Automatic sync failed

              The automatic synchronization of \`main\` â†’ \`develop\` failed due to merge conflicts.

              ### Action Required

              Please manually merge \`main\` into \`develop\`:

              \`\`\`bash
              git checkout develop
              git pull origin develop
              git merge origin/main
              # Resolve conflicts in your editor
              git commit
              git push origin develop
              \`\`\`

              ### Context

              - **Workflow:** ${{ github.workflow }}
              - **Run:** ${{ github.run_number }}
              - **Triggered by:** ${{ github.event_name }}
              - **Commit:** ${{ github.sha }}

              This issue will be automatically closed when the merge is completed.`,
              labels: ['automation', 'merge-conflict']
            });

            console.log(`Created issue #${issue.data.number}`);
